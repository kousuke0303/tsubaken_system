<div class="col-sm-12 text-right mb-1e">
  <button class="btn btn-dark" id="add-task"><i class="fas fa-plus"></i> 新規タスク</button>
</div>

<div id="kanban-tasks"></div>

<script>
// タスク移動関連
$(document).ready(function(){
  //初期状態のタスク管理ボード用JSONデータ
  const defaultBoards = [
    {
      "id": "default-tasks",
      "title": "デフォルトタスク一覧",
      "class": "default",
      "item": [
        <% @default_tasks.each do |task| %>    
          { 
            "title": "<%= task.title.truncate(11) %>",
            "id": "<%= task.id %>",
            "task-title": "<%= task.title %>",
            "task-content": "<%= task.content %>",
            "task-status": "<%= task.status %>"
          },
        <% end %>
      ]
    },
    
    {
      "id": "relevant-tasks",
      "title": "当該タスク",
      "class": "relevant",
      "item": [
        <% @relevant_tasks.each do |task| %>    
          {
            "title": "<%= task.title.truncate(11) %>",
            "id": "<%= task.id %>",
            "task-title": "<%= task.title %>",
            "task-content": "<%= task.content %>",
            "task-status": "<%= task.status %>"
          },
        <% end %>
      ]
    },

    {
      "id": "ongoing-tasks",
      "title": "進行中",
      "class": "ongoing",
      "item": [
        <% @ongoing_tasks.each do |task| %>    
          {
            "title": "<%= task.title.truncate(11) %>",
            "id": "<%= task.id %>",
            "task-title": "<%= task.title %>",
            "task-content": "<%= task.content %>",
            "task-status": "<%= task.status %>"
          },
        <% end %>
      ]
    },

    {
      "id": "finished-tasks",
      "title": "完了",
      "class": "finished",
      "item": [
        <% @finished_tasks.each do |task| %>    
          { 
            "title": "<%= task.title.truncate(11) %>",
            "id": "<%= task.id %>",
            "task-title": "<%= task.title %>",
            "task-content": "<%= task.content %>",
            "task-status": "<%= task.status %>"
          },
        <% end %>
      ]
    }
  ];
  
  //jKanbanのインスタンス作成
  var kanban = new jKanban({
    element         : "#kanban-tasks",  //タスク管理ボードを表示するHTML要素
    gutter          : "5px",       //ボード同士の間隔
    widthBoard      : "250px",      //ボードのサイズ
    boards          : defaultBoards,//初期状態のJSONデータ
    
    dropEl: function(el, target, a, b){
      var task = el.getAttribute("data-eid");
      var status = target.parentNode.getAttribute("data-id");
      var item_arrey = target.children;
      item_arrey = [].slice.call(item_arrey);
      var item_index = item_arrey.indexOf(el);

      $.ajax({
        type: "POST",
        url: "<%= move_employees_matter_tasks_path(@matter) %>",
        cache: false,
        data: { task: task, status: status, item_index: item_index, remote: true }
      });
    }
  });

    var addTaskButton = document.getElementById("add-task");
    addTaskButton.addEventListener("click",function(){
      
      const formItem = document.createElement("form");
      formItem.innerHTML = '<input type="text", id="new-task-form">';
      kanban.addForm("relevant-tasks", formItem);
  
      $("#new-task-form").blur(function(){
        var title = $("#new-task-form").val();

        $.ajax({
          type: "POST",
          url: "<%= employees_matter_tasks_path(@matter) %>",
          cache: false,
          data: { title: title, remote: true }
      });
    });
  });
  // 現状使用しない
  //var removeItem = document.getElementById('Item_reset');
  //removeItem.addEventListener('click',function(){
  //    $('div[data-id="finished_task"] main div').each(function(index, element){
  //      kanban.removeElement(element)
  //    });
  //    $.ajax({
  //        type: "GET",
  //        url: "",
  //        cache: false,
  //    });
  //  });
});
  
</script>

<script>
  <% @matter.tasks.each do |task| %>
    $(function(){
      <% if task.manager %>
        $("[data-eid=<%= task.id %>]").html('<div class="task-manager-icon"><div><%= task.manager.name[0, 2] %></div></div><div class="task-title"><div>| <%= task.title %></div></div>');
      <% elsif task.staff %>
        $("[data-eid=<%= task.id %>]").html('<div class="task-staff-icon"><div><%= task.staff.name[0, 2] %></div></div><div class="task-title"><div>| <%= task.title %></div></div>');
      <% elsif task.external_staff %>
        $("[data-eid=<%= task.id %>]").html('<div class="task-external-staff-icon"><div><%= task.external_staff.name[0, 2] %></div></div><div class="task-title"><div>| <%= task.title %></div></div>');
      <% else %>
        $("[data-eid=<%= task.id %>]").html('<span>なし</span> | <%= task.title %>');
      <% end %>

      // タスク編集モーダル
      $("[data-eid=<%= task.id %>]").on("click",function(){
        let matterId = "<%= @matter.id %>"
        let taskId = this.getAttribute("data-eid");
        let taskTitle = this.getAttribute("data-task-title");
        let taskContent = this.getAttribute("data-task-content");
        let taskStatus = this.getAttribute("data-task-status");
        let url = "/employees/matters/" + matterId + "/tasks/" + taskId
        $("#task-edit").modal();
        $("#task-title").val(taskTitle);
        $("#task-content").val(taskContent);
        $("#edit-task-form").attr("action", url);
        $("#destroy-task").attr("href", url);
        $("#task-edit").find("div.modal-header").addClass("modal-header-" + taskStatus);
      });
    });
  <% end %>
</script>