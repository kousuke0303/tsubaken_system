<% @estimates.each do |estimate| %>
  <div class="pdf-estimate">
    <% details_hash = @estimate_details.where(estimate_details: { estimate_id: estimate.id }).order(:sort_number).group_by{ |detail| detail[:category_id] } %>
    <div class="header">
      <div class="estimate-title"><%= Constants::UPPERCASE_LATTER[estimate.position - 1] %> プラン</div>
      <div class="title">御見積書</div>
    </div>

    <div class="client-info">
      現場名称：<%= @estimate_matter.title %><br>
      現場住所：<%= "#{ @estimate_matter.prefecture_code }#{ @estimate_matter.address_city }#{ @estimate_matter.address_street }" %>
    </div>
    <div class="company-info">
      <div class="company-logo"><%= wicked_pdf_image_tag "profile.jpg", size: "60x60", alt: "ロゴ" %></div>
      <div class="company-name">株式会社　ツバケン</div>
      <div class="company-tel">
        TEL: 090-8787-5544
        <span class="person-in-charge">テスト　太郎</span>
      </div>
    </div>

    <table class="table table-sm pdf-estimate-table">
      <thead>
        <tr>
          <td rowspan=2 style="width: 35%;">工事名称</td>
          <td colspan=2>数量</td>
          <td colspan=2 style="width: 20%;">見積金額</td>
          <td rowspan=2 style="width: 25%;">摘要(仕様)</td>
        </tr>
        <tr>
          <td style="width: 13%;">数量</td>
          <td style="width: 7%;">単位</td>
          <td style="width: 8%;">単価</td>
          <td style="width: 12%;">金額</td>
        </tr>
      </thead>
      <tbody>
        <% details_hash.each do |category_id, details| %>
          <% @category_total = 0 %>
          <tr>
            <td colspan=6 class="category-name">
              <span class="square"><i class="fa fa-square"></i></span>
              <%= details[0].category_name %><%= details.length %>
            </td>
          </tr>
          <% details.each do |detail| %>
            <tr>
              <% if detail.material_id.present? %>            
                <td class="detail-name"><%= detail.material_name %></td>
                <td class="detail-amount"><%= detail.amount %></td>
                <td class="detail-unit"><%= detail.unit %></td>
                <td class="detail-price money-type"><%= detail.price %></td>
                <td class="detail-total money-type"><%= detail.total %></td>
                <td class="detail-specification"><%= detail.note %></td>
              <% elsif detail.construction_id.present? %>
                <td class="detail-name"><%= detail.construction_name %></td>
                <td class="detail-amount"><%= detail.amount %></td>
                <td class="detail-unit"><%= detail.unit %></td>
                <td class="detail-price money-type"><%= detail.price %></td>
                <td class="detail-total money-type"><%= detail.total %></td>
                <td class="detail-specification"><%= detail.note %></td>
              <% end %>
              <% @category_total += detail.total if detail.total %>
            </tr>
          <% end %>
          <tr class="category-footer">
            <td class="category-footer-1">小計</td>
            <td class="category-footer-2"></td>
            <td class="category-footer-3"></td>
            <td class="category-footer-4"></td>
            <td class="category-footer-5 money-type"><%= @category_total %></td>
            <td class="category-footer-6"></td>
          </tr>
        <% end %>
      </tbody>
      <tfoot>
        <tr>
          <td colspan=3 class="footer-item-1">合計</td>
          <td colspan=2 class="footer-item-2 money-type"><%= estimate.total_price %></td>
          <td rowspan=5 class="footer-item-3">備考：</td>
        </tr>
        <tr>
          <td colspan=3 class="footer-item-1">端数値引</td>
          <td colspan=2 class="footer-item-2 money-type"><%= estimate.discount %></td>
        </tr>
        <tr>
          <td colspan=3 class="footer-item-1 estimate-total">御見積見学　(消費税抜)</td>
          <td colspan=2 class="footer-item-2 estimate-total money-type pure-total"><%= estimate.after_discount %></td>
        </tr>
        <tr>
          <td colspan=3 class="footer-item-1">消費税(10%)</td>
          <td colspan=2 class="footer-item-2 money-type"><%= estimate.consumption_tax %></td>
        </tr>
        <tr>
          <td colspan=3 class="footer-item-1">御見積見学　(消費税込)</td>
          <td colspan=2 class="footer-item-2 money-type"><%= estimate.total_with_tax %></td>
        </tr>
      </tfoot>
    </table>
  </div>
<% end %>

<script>
  $('.money-type').each(function(i, element){
    var text = $(element).text();
    var moneyType = String(text).replace( /(\d)(?=(\d\d\d)+(?!\d))/g, "$1," );
    $(element).text(moneyType);
  });
</script>
