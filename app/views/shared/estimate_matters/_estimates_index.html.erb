<% @estimates.group_by {|estimate| estimate.id }.each_with_index do |estimate, index| %>
  <% total_price = 0 %>
  <p class="mt-1e mb-0"><%= estimate_type(index) %> TYPE</p>
   
  
  <div class="flex estimate-table-header">
    <div class="estimate-name">プラン名</div>
    <div style="width: 80%;" class="flex">
      <div class="category-name">カテゴリ</div>
      <div class="construction-material flex">
        <div class="construction-material-detail">素材・工事名</div>
        <div class="construction-material-detail">耐用年数</div>
        <div class="construction-material-detail">単価</div>
        <div class="construction-material-detail">単位</div>
        <div class="construction-material-detail">数量</div>
        <div class="construction-material-detail-total">合計金額</div>
      </div>
    </div>
  </div>
  <% estimate = estimate[1] %>
  <div class="estimate-table-body flex">
    <!-- 見積のプラン名 -->
    <div class="estimate-name">
      <div class= home_icon_2>
        <div class="triangle" style="border-bottom-color: #dc3545"></div>
        <div class="square" style="background: #dc3545">
          <div class="window">
            <div><p>■■</p><p>■■</p></div>
          </div>
          <div class="text">
            <% if current_client %>
              <%= estimate[0].title %>
            <% else %>
              <%= link_to estimate[0].title, edit_employees_estimate_matter_estimate_path(@estimate_matter, estimate[0].id),
                                      remote: true %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div style="width: 80%;">
      <% estimate.group_by { |category| category.category_id }.each_with_index do |category, index| %>
        <% category = category[1] %>
        <% if category_id = category[0].category_id %>
          <% last = "last" if index == estimate.size - 1 %>
          <div class="flex category-item category-item-<%= last %>">
            <div class="category-name category-name-<%= last %>">
              <% if current_client %>
                <%= category[0].category_name %>
              <% else %>   
                <%= link_to category[0].category_name ,edit_employees_estimate_matter_category_path(@estimate_matter, category[0].category_id), remote: true %>
              <% end %>
            </div>
            <div class="construction-material construction-material-<%= last %>">              
              <% if @materials %>
                <% materials = @materials.where(categories: { id: category_id }) %>
                <% if materials.size > 0 %>
                  <% material_presence = true %>                
                <% else %>
                  <% material_presence = false %>
                <% end %>
                <% materials.each_with_index do |material, index| %>
                  <% if index == materials.size - 1 %>
                    <% last = "last" %>
                  <% else %>
                    <% last = "" %>
                  <% end %>
                  <div class="flex construction-material-item construction-material-item-<%= last %>">
                    <div class="construction-material-detail">
                      <% if current_client %>
                        <%= material.name %>
                      <% else %>
                        <%= link_to material.name, edit_employees_estimate_matter_material_path(@estimate_matter, material.id),
                                                   remote: true, class: "btn btn-sm btn-dark" %>
                      <% end %>
                    </div>
                    <div class="construction-material-detail"><%= material.service_life %></div>
                    <div class="construction-material-detail"><%= material.price %></div>
                    <div class="construction-material-detail"><%= material.unit %></div>
                    <div class="construction-material-detail"><%= material.amount %></div>
                    <% total_price = total_price.to_i + material.total.to_i %>
                    <div class="construction-material-detail-total"><%= "#{ material.total }円" if material.total.present? %></div>
                  </div>
                <% end %>
              <% end %>
              <% if @constructions %>
                <% constructions = @constructions.where(categories: { id: category_id }) %>
                <% constructions.each_with_index do |construction, index| %>
                  <% if index == 0 && material_presence %>
                    <% with_border_top = "with-border-top" %>
                  <% else %>
                    <% with_border_top = "" %>
                  <% end %>
                  <% if index == constructions.size - 1 %>
                    <% last = "last" %>
                  <% else %>
                    <% last = "" %>
                  <% end %>
                  <div class="flex construction-material-item <%= with_border_top %> construction-material-item-<%= last %>">
                    <div class="construction-material-detail">
                      <% if current_client %>
                        <%= construction.name %>
                      <% else %>
                        <%= link_to construction.name, edit_employees_estimate_matter_construction_path(@estimate_matter, construction.id),
                                                      remote: true, class: "btn btn-sm btn-dark" %>
                      <% end %>
                    </div>
                    <div class="construction-material-detail"></div>
                    <div class="construction-material-detail"><%= construction.price %></div>
                    <div class="construction-material-detail"><%= construction.unit %></div>
                    <div class="construction-material-detail"><%= construction.amount %></div>
                    <% total_price = total_price.to_i + construction.total.to_i %>
                    <div class="construction-material-detail-total"><%= "#{ construction.total }円" if construction.total.present? %></div>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
  <div class="estimate-table-footer">
    合計見積金額 <%= total_price %>円
  </div>
  <div class="float-r">
    <% unless current_client %>
      <%= link_to "COPY", copy_employees_estimate_matter_estimate_path(@estimate_matter, estimate[0]), method: :post, remote: true,
                              data: { confirm: "この見積を複製してよろしいですか？" }, class: "btn btn-sm btn-primary" %>
    <% end %>
    </div>
<% end %>

<% @estimate_matter.estimates.each do |estimate| %>

  <table class="table table-bordered table_line_type">
    <thead>
      <tr>
        <th>プラン名</th>
        <th>項目</th>
        <th>工事名称・素材</th>
        <th>耐用年数</th>
        <th>単価</th>
        <th>単位</th>
        <th>数値</th>
        <th>計</th>
      </tr>
      <tr>
        <td rowspan="<%= plan_row_span(estimate.id) %>">
          <div class= home_icon_2>
            <div class="triangle" style="border-bottom-color: #dc3545"></div>
            <div class="square" style="background: #dc3545">
              <div class="window">
                <div><p>■■</p><p>■■</p></div>
              </div>
              <div class="text">
                <% if current_client %>
                  <%= estimate.title %>
                <% else %>
                  <%= link_to estimate.title, edit_employees_estimate_matter_estimate_path(@estimate_matter, estimate.id),
                                          remote: true %>
                <% end %>
              </div>
            </div>
          </div>
        </td>
        <% @first_category = estimate.categories.first %>
        <td rowspan="<%= category_row_span(@first_category) %>">
          <%= category_name(@first_category.id) %>
        </td>
        <% @first_material = @first_category.materials.first if @first_category.materials.present? %>
        <td><%= @first_material.name %></td>
        <td><%= @first_material.service_life %></td>
        <td><%= @first_material.price %></td>
        <td><%= @first_material.unit %></td>
        <td><%= @first_material.amount %></td>
        <td><%= %></td>
      </tr>
      <% if @first_category.materials.count > 1 %>
        <% @first_category.materials.offset(1).each do |material| %>
          <tr>
            <td><%= material.name %></td>
            <td><%= material.service_life %></td>
            <td><%= material.price %></td>
            <td><%= material.unit %></td>
            <td><%= material.amount %></td>
            <td></td>
          </tr>
        <% end %>
      <% end %>
      <% if estimate.categories.count > 1 %>
        <% estimate.categories.offset(1).each do |category| %>
          <tr>
            <td rowspan="<%= category_row_span(category) %>"><%= category_name(category.id) %></td>
            <td><%= category.materials.first.name if category.materials.present? %></td>
            <td>年数</td>
            <td>単価</td>
            <td>単位</td>
            <td></td>
            <td></td>
          </tr>
          <% category.materials.offset(1).each do |material| %>
            <tr>
              <td><%= material.name %></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
          <% end %>
        <% end %>
      <% end %>
    </thead>
  </table>
<% end %>
